local Zellen = {}
Zellen[1] = false
Zellen[2] = false
Zellen[3] = false
Zellen[4] = false
Zellen[5] = false
Zellen[6] = false
Zellen[7] = false
Zellen[8] = false
Zellen[9] = false
Zellen[10] = false
Zellen[11] = false
Zellen[12] = false
Zellen[13] = false
Zellen[14] = false
Zellen[15] = false
Zellen[16] = false
Zellen[17] = false
Zellen[18] = false
Zellen[19] = false
Zellen[20] = false
Zellen[21] = false
Zellen[22] = false
Zellen[23] = false
Zellen[24] = false
Zellen[25] = false
Zellen[26] = false
Zellen[27] = false
Zellen[28] = false
Zellen[29] = false
Zellen[30] = false
Zellen[31] = false

local CellKoords = {}

for i=1, 31, 1 do

	CellKoords[i] = {}

end

CellKoords[1]["x"], CellKoords[1]["y"], CellKoords[1]["z"], CellKoords[1]["rot"] = 2426.2802734375, -1286.552734375, 994.54663085938, 0
CellKoords[2]["x"], CellKoords[2]["y"], CellKoords[2]["z"], CellKoords[2]["rot"] = 2430.2585449219, -1286.3759765625, 994.54663085938, 0
CellKoords[3]["x"], CellKoords[3]["y"], CellKoords[3]["z"], CellKoords[3]["rot"] = 2433.9345703125, -1286.7724609375, 994.54663085938, 0
CellKoords[4]["x"], CellKoords[4]["y"], CellKoords[4]["z"], CellKoords[4]["rot"] = 2438.271484375, -1286.47265625, 994.54663085938, 0
CellKoords[5]["x"], CellKoords[5]["y"], CellKoords[5]["z"], CellKoords[5]["rot"] = 2442.1767578125, -1286.5126953125, 994.54663085938, 0
CellKoords[6]["x"], CellKoords[6]["y"], CellKoords[6]["z"], CellKoords[6]["rot"] = 2446.14453125, -1286.4384765625, 994.54663085938, 0
CellKoords[7]["x"], CellKoords[7]["y"], CellKoords[7]["z"], CellKoords[7]["rot"] = 2450.3330078125, -1286.3212890625, 994.54663085938, 0

CellKoords[8]["x"], CellKoords[8]["y"], CellKoords[8]["z"], CellKoords[8]["rot"] = 2426.10546875, -1286.1669921875, 988.19055175781, 0
CellKoords[9]["x"], CellKoords[9]["y"], CellKoords[9]["z"], CellKoords[9]["rot"] = 2430.3154296875, -1286.5556640625, 988.19055175781, 0
CellKoords[10]["x"], CellKoords[10]["y"], CellKoords[10]["z"], CellKoords[10]["rot"] = 2433.9326171875, -1286.6484375, 988.19055175781, 0
CellKoords[11]["x"], CellKoords[11]["y"], CellKoords[11]["z"], CellKoords[11]["rot"] = 2438.1279296875, -1286.4072265625, 988.19055175781, 0
CellKoords[12]["x"], CellKoords[12]["y"], CellKoords[12]["z"], CellKoords[12]["rot"] = 2442.373046875, -1286.78515625, 988.19055175781, 0
CellKoords[13]["x"], CellKoords[13]["y"], CellKoords[13]["z"], CellKoords[13]["rot"] = 2445.7314453125, -1286.3681640625, 988.19055175781, 0
CellKoords[14]["x"], CellKoords[14]["y"], CellKoords[14]["z"], CellKoords[14]["rot"] = 2450.078125, -1286.4755859375, 988.19055175781, 0

CellKoords[15]["x"], CellKoords[15]["y"], CellKoords[15]["z"], CellKoords[15]["rot"] = 2450.125, -1262.5888671875, 988.19055175781, 180
CellKoords[16]["x"], CellKoords[16]["y"], CellKoords[16]["z"], CellKoords[16]["rot"] = 2446.1611328125, -1262.822265625, 988.19055175781, 180
CellKoords[17]["x"], CellKoords[17]["y"], CellKoords[17]["z"], CellKoords[17]["rot"] = 2442.3681640625, -1262.9775390625, 988.19055175781, 180
CellKoords[18]["x"], CellKoords[18]["y"], CellKoords[18]["z"], CellKoords[18]["rot"] = 2438.1865234375, -1262.5302734375, 988.19055175781, 180
CellKoords[19]["x"], CellKoords[19]["y"], CellKoords[19]["z"], CellKoords[19]["rot"] = 2434.0068359375, -1262.2841796875, 988.19055175781, 180
CellKoords[20]["x"], CellKoords[20]["y"], CellKoords[20]["z"], CellKoords[20]["rot"] = 2430.2197265625, -1262.7744140625, 988.19055175781, 180
CellKoords[21]["x"], CellKoords[21]["y"], CellKoords[21]["z"], CellKoords[21]["rot"] = 2426.4345703125, -1262.283203125, 988.19055175781, 180

CellKoords[22]["x"], CellKoords[22]["y"], CellKoords[22]["z"], CellKoords[22]["rot"] = 2450.3408203125, -1262.4375, 994.54632568359, 180
CellKoords[23]["x"], CellKoords[23]["y"], CellKoords[23]["z"], CellKoords[23]["rot"] = 2446.36328125, -1262.6083984375, 994.54638671875, 180
CellKoords[24]["x"], CellKoords[24]["y"], CellKoords[24]["z"], CellKoords[24]["rot"] = 2442.0654296875, -1262.55078125, 994.54638671875, 180
CellKoords[25]["x"], CellKoords[25]["y"], CellKoords[25]["z"], CellKoords[25]["rot"] = 2437.9384765625, -1262.4052734375, 994.54632568359, 180
CellKoords[26]["x"], CellKoords[26]["y"], CellKoords[26]["z"], CellKoords[26]["rot"] = 2434.0771484375, -1262.84375, 994.54638671875, 180
CellKoords[27]["x"], CellKoords[27]["y"], CellKoords[27]["z"], CellKoords[27]["rot"] = 2430.140625, -1262.0654296875, 994.54632568359, 180
CellKoords[28]["x"], CellKoords[28]["y"], CellKoords[28]["z"], CellKoords[28]["rot"] = 2426.212890625, -1262.0224609375, 994.546875, 180

CellKoords[29]["x"], CellKoords[29]["y"], CellKoords[29]["z"], CellKoords[29]["rot"] = 2462.5810546875, -1262.0634765625, 988.19055175781, 180
CellKoords[30]["x"], CellKoords[30]["y"], CellKoords[30]["z"], CellKoords[30]["rot"] = 2466.3837890625, -1261.81640625, 988.19055175781, 180
CellKoords[31]["x"], CellKoords[31]["y"], CellKoords[31]["z"], CellKoords[31]["rot"] = 2470.53125, -1262.1376953125, 988.19055175781, 180

addEvent ( "onPlayerGetsFreed", true )

function getFreeCell ( )

	local va = false
	local num = false
	local vale = 0
		
	while va == false do
	
		if vale == 31 then
			return false
		end
	
		num = math.random ( 1, 31 )
		
		if Zellen[num] == false then
			va = true
			return num
		end
		
		vale = vale+1
	
	end
	
end

function getCellCoords ( count )

	if count == false then
		return 2443.1318359375, -1274.8173828125, 988.19055175781, 110
	end

	return CellKoords[count]["x"], CellKoords[count]["y"], CellKoords[count]["z"], CellKoords[count]["rot"]

end

function cellHandlerFunc ( player )

		if not player then
		
			player = source
			
		end
		
		if not source then
		
			source = player
			
		end

		local cell = getElementData ( source, "playerCelled" )
		Zellen[cell] = false
		removeElementData ( source, "playerCelled" )
		removeEventHandler ( "onPlayerGetsFreed", source, cellHandlerFunc )
		removeEventHandler ( "onPlayerQuit", source, cellHandlerFunc )
		removeEventHandler ( "onPlayerWasted", source, cellHandlerFunc )

end

function putPlayerInFreeCell ( player )

	local cell = getFreeCell()
	
	if cell == false then
	else
		Zellen[cell] = getPlayerName ( player )
		setElementData ( player, "playerCelled", cell )
		addEventHandler ( "onPlayerGetsFreed", player, cellHandlerFunc )
		addEventHandler ( "onPlayerQuit", player, cellHandlerFunc )
		addEventHandler ( "onPlayerWasted", player, cellHandlerFunc )
	end
	local x, y, z, rz = getCellCoords ( cell )
	
	setElementPosition ( player, x, y, z )
	setElementRotation ( player, 0, 0, rz )
	setElementInterior ( player, 2 )
	
end

LVJailArea = createColCuboid ( 2278.166015625, 2424.8486328125, 3.0, 6.799804685, 10.05, 4.08400478363 )
local sfprisonjail = createColSphere ( 2421.4072265625, -1273.099609375, 988.19055175781, 5 )
function isInLVJailArea ( player )

	local x1, y1, z1 = getElementPosition ( player )
	if getDistanceBetweenPoints3D ( x1, y1, z1, 198.08735656738, 174.32916259766, 1002.672668457 ) < 10 then
		return true
	else
		return false
	end
end
function isInSFJailArea ( player )

	--[[local x, y, z = getElementPosition ( player )
	if x < 229 and x > 213 and y < 116 and y > 107 and z < 1002 and z > 950 then
		return true
	else
		return false
	end]]
	
	return isElementWithinColShape ( player, sfprisonjail )
end

function isInSFCarJailArea ( player )

	local x, y, z = getElementPosition ( player )
	if getDistanceBetweenPoints3D ( -1590, 716, 0, x, y, 0 ) < 6.5 then
		return true
	else
		return false
	end
end
function isInLVCarJailArea ( player )

	return isElementWithinColShape ( player, LVJailArea )
end

function arrest_func ( player, cmd, target, bail )
	
	if target ~= nil then
	
		target = findPlayerByName( target )
		local arrest_wanteds = tonumber(vioGetElementData( target, "wanteds" ))
		local time
		local fine
		local kaution
		
		if not bail then bail = 0 end
		-----------------------------------------------------
		if bail then
		
			bail = math.abs ( math.floor ( tonumber ( bail ) ) )
			
			if bail ~= 1 and bail ~= 0 then
			
				triggerClientEvent ( player, "infobox_start", getRootElement(), "/arrest [Name] [1/0]!", 5000, 125, 0, 0 )
				return
			
			end
			
			if bail == 0 then
			
				time = arrest_wanteds * 10
				fine = 100 * arrest_wanteds * arrest_wanteds
				kaution = 0
			
			elseif bail == 1 then
			
				time = arrest_wanteds * 7
				fine = 70 * arrest_wanteds * arrest_wanteds
				
				if arrest_wanteds <= 3 then 
				
					kaution = 200 * arrest_wanteds * arrest_wanteds
				
				elseif arrest_wanteds > 3 then 
				
					kaution = 2000 * arrest_wanteds * arrest_wanteds
				
				end
			
			end
				
		end
		----------------------------------------------------------------
		if isOnDuty ( player ) then
			
			local bool = isInLVJailArea ( player )
			
			if isInLVJailArea ( target ) and isInLVJailArea ( player ) then
			
				bool = true
				
			elseif isInSFJailArea ( target ) and isInSFJailArea ( player ) then
			
				bool = true
				
			elseif isInLVCarJailArea ( target ) and isInLVCarJailArea ( player ) then
			
				bool = true
				
			elseif isInSFCarJailArea ( target ) and isInSFCarJailArea ( player ) then
			
				bool = true
				
			else
			
				bool = false
				
			end
			
			if bool then
			
			-- Hier JAIL
							
				if arrest_wanteds >= 1 then
						
					if getPedOccupiedVehicle ( target ) ~= false then removePedFromVehicle ( target ) end
					
					local boolean = not vioGetElementData ( target, "tied" )
					
					if boolean then 
					
						fix = "ent" 
						
						vioSetElementData ( target, "tied", boolean )
						toggleAllControls ( target, boolean )
											
						if fix == "ent" then
							fadeCamera ( target, true, 0.5, 0, 0, 0 )
							removeEventHandler ( "onPlayerCommand", target, block_tie_cmds )
						end
					
					end
					
					if vioGetElementData ( target, "jailtime" ) > 0 then
					
						cellHandlerFunc ( target )
					
					end
													
					arrestPlayer ( player, target, time, fine, kaution )
						
				else
				
					triggerClientEvent ( player, "infobox_start", getRootElement(), "Der Buerger hat\nkeine Verbrechen\nbegangen!", 5000, 125, 0, 0 )
						
				end
					
			-------------------------------
			
			else
			
				triggerClientEvent ( player, "infobox_start", getRootElement(), "\nIhr muesst\nbei den Zellen sein!", 5000, 125, 0, 0 )
			
			end
						
		else
		
			triggerClientEvent ( player, "infobox_start", getRootElement(), "Du bist\nkein Polizist im\nDienst!", 5000, 125, 0, 0 )
			
		end
		
	else
	
		triggerClientEvent ( player, "infobox_start", getRootElement(), "Gebrauch:\n/arrest [Name]\n[Kaution, 0/1]", 5000, 125, 0, 0 )
		
	end
	
end

addCommandHandler ( "arrest", arrest_func )

--[[function carrest_func ( player, cmd, target, time, fine, bail )
	
	if target ~= nil then
		target = getPlayerFromName(target)
		local x, y, z = getElementPosition ( player )
		local tx, ty, tz = getElementPosition ( target )
		fine = math.abs ( math.floor ( tonumber ( fine ) ) )
		bail = math.abs ( math.floor ( tonumber ( bail ) ) )
		time = math.abs ( math.floor ( tonumber ( time ) ) )
		if isOnDuty ( player ) or isArmy(player) then
			local bool = ( isInLVCarJailArea ( player ) and isInLVCarJailArea ( target ) )
			if getDistanceBetweenPoints3D ( -1590, 716, 0, x, y, 0 ) < 6.5 or bool then
				if getDistanceBetweenPoints3D ( -1590, 716, 0, tx, ty, 0 ) < 6.5 or bool then
					if vioGetElementData ( target, "wanteds" ) >= 1 then
						removePedFromVehicle ( target )
						arrestPlayer ( player, target, time, fine, bail )
					else
						triggerClientEvent ( player, "infobox_start", getRootElement(), "Der Buerger hat\nkeine Verbrechen\nbegangen!", 5000, 125, 0, 0 )
					end
				else
					triggerClientEvent ( player, "infobox_start", getRootElement(), "\n\nZiel ist\nbeim Carport!", 7500, 125, 0, 0 )
				end
			else
				triggerClientEvent ( player, "infobox_start", getRootElement(), "\n\nDu bist nicht\nam Carport!", 7500, 125, 0, 0 )
			end
		else
			triggerClientEvent ( player, "infobox_start", getRootElement(), "Du bist\nkein Polizist im\nDienst!", 7500, 125, 0, 0 )
		end
	else
		triggerClientEvent ( player, "infobox_start", getRootElement(), "Gebrauch:\n/carrest [Name]\n[Zeit] [Bail\n 0=Nein]", 7500, 125, 0, 0 )
	end
end
addCommandHandler ( "carrest", carrest_func )]]

function arrestPlayer ( officer, player, time, fine, bail )

	local money = vioGetElementData ( player, "money" )
	if fine > money then		
		vioSetElementData ( player, "money", 0 )
	else
		vioSetElementData ( player, "money", money - fine )
	end
	if vioGetElementData ( player, "tied" ) then
		fadeCamera ( player, true, 0.5, 0, 0, 0 )
		toggleAllControls ( player, true )
	end
	vioSetElementData ( player, "jailtime", time )
	vioSetElementData ( officer, "boni", vioGetElementData ( officer, "boni" ) + vioGetElementData ( player, "wanteds" ) * wantedprice )
	if bail == nil then bail = 0 end
	if bail == 0 then
		vioSetElementData ( player, "bail", 0 )
		outputChatBox ( "Du hast den Spieler "..getPlayerName ( player ).." ohne Kaution fuer "..fine.." $ und "..time.." Minuten eingesperrt!", officer, 0, 125, 0 )
		outputChatBox ( "Du wurdest von Polizist "..getPlayerName ( officer ).." ohne Kaution fuer "..fine.." $ und "..time.." Minuten eingesperrt!", player, 0, 125, 0 )
	else
		vioSetElementData ( player, "bail", bail )
		outputChatBox ( "Du wurdest von Polizist "..getPlayerName ( officer ).." mit "..bail.." $ Kaution fuer "..fine.." $ und "..time.." Minuten eingesperrt!", player, 0, 125, 0 )
		outputChatBox ( "Du hast den Spieler "..getPlayerName ( player ).." mit "..bail.." $ Kaution fuer "..fine.." $ und "..time.." Minuten eingesperrt!", officer, 0, 125, 0 )
	end
	outputChatBox ( getPlayerRankName ( officer ).." "..getPlayerName ( officer ).." hat "..getPlayerName ( player ).." eingesperrt!", getRootElement(), 0, 0, 150 )
	
	putPlayerInJail ( player )
end

local knast_cmds = {}
knast_cmds["smoke"] = true
knast_cmds["usedrugs"] = true
knast_cmds["sellgun"] = true

function disbaleKnastCMD ( cmd )

	if knast_cmds[cmd] then
		cancelEvent()
	end

end

function putPlayerInJail ( player )

	takeAllWeapons ( player )
	vioSetElementData ( player, "wanteds", 0 )
	setPlayerWantedLevel ( player, 0 )
	triggerClientEvent ( player, "jailKeyDisable", player )
	
	putPlayerInFreeCell ( player )
	addEventHandler( "onPlayerCommand", player, disbaleKnastCMD )
	setElementDimension ( player, 0 )
	
end

function bail_func ( player )

	if vioGetElementData ( player, "jailtime" ) == 0 then
		triggerClientEvent ( player, "infobox_start", getRootElement(), "\nDu bist nicht\nim Gefaengnis!", 5000, 125, 0, 0 )
	else
		if vioGetElementData ( player, "bail" ) == 0 then
			triggerClientEvent ( player, "infobox_start", getRootElement(), "\nDu hast\nkeine Kaution!", 5000, 125, 0, 0 )
		else
			local bail = vioGetElementData ( player, "bail" )
			local money = vioGetElementData ( player, "money" )
			if bail <= money then
				vioSetElementData ( player, "money", money - bail )
				freePlayerFromJail ( player )
			else
				infobox ( player, "Du hast\nzu wenig Geld!\nKosten:\n"..bail, 5000, 125, 0, 0 )
			end
		end
	end
end
addCommandHandler ( "bail", bail_func )

function freePlayerFromJail ( player )
	removeEventHandler ( "onPlayerCommand", player, disbaleKnastCMD )
	triggerEvent ( "onPlayerGetsFreed", player, player )
	vioSetElementData ( player, "jailtime", 0 )
	vioSetElementData ( player, "bail", 0 )
	vioSetElementData ( player, "jailtime", 0 )
	toggleControl ( player, "enter_exit", true )
	toggleControl ( player, "fire", true )
	toggleControl ( player, "jump", true )
	toggleControl ( player, "action", true )
	if vioGetElementData ( player, "heaventime" ) == 0 then
		infobox ( player, "Du bist wieder\nfrei! Benimm dich\nin Zukunft besser!", 5000, 0, 200, 0 )
		setElementInterior ( player, 0 )
		if getElementData ( player, "jail" ) == "lv" then
			setElementPosition ( player, 2340.1567382813, 2451.8452148438, 14.62340164 )
			setPedRotation ( player, 180 )
		else
			setElementPosition ( player, -1605.675, 717.516, 12.006 )
		end
	end
end

function jailtime_func ( player )

	local jailtime = vioGetElementData ( player, "jailtime" )
	if jailtime == 0 then
		infobox ( player, "\nDu bist nicht\nim Gefaengnis!", 5000, 125, 0, 0 )
	else
		outputChatBox ("Du bist noch fuer "..jailtime.." Minuten im Gefaengnis!", player, 0, 125, 0 )
	end
end
addCommandHandler ( "jailtime", jailtime_func )